---
title: "Analyses"
author: "Theodor Adrian Balan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tests on data sets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## rats data
```{r rats1}
dat <- survival::rats

library(frailtoys)
m1 <- emfrail(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
              .distribution = emfrail_distribution(dist = "gamma"),
              .control = emfrail_control( opt_fit = TRUE, verbose = FALSE))

# m1_cph <- coxph(Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + frailty(litter),
#                 ties = "breslow",
#                 data = dat)

# library(parfm)
# m1_parfm <- parfm(formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex, data = dat, frailty = "gamma", dist = "exponential", cluster = "litter")
# 
# m1_fsurv <- fitfrail(Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter), dat, frailty = "gamma", se = FALSE)
# 
# 
# m1_fsurv$Lambda.fun(seq(0, 100, by=10))
# 
# 
# a <- survfit(m1_cph)
# 
# b <- predict(m1, lp = t(m1$res$coef) %*% (m1$mcox$means), quantity = "cumhaz", conf_int = NULL)
# 
# plot(a$time, a$cumhaz)
# lines(b$time, b$cumhaz, col = 2, type = "s")
# points(a$time, m1_fsurv$Lambda.fun(a$time), col = 3)
# lines(a$time, 0.002*a$time, col = 3)
# 
# plot(m1$res$z$z, exp(m1_cph$frail))
# points(predict(m1_parfm), col = 2)
# m1$res$z


m2 <- emfrail(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
              .distribution = emfrail_distribution(dist = "pvf"))

m3 <- emfrail(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
              .distribution = emfrail_distribution(dist = "pvf", pvfm = 1/2))

m4 <- emfrail(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
              .distribution = emfrail_distribution(dist = "stable"),
              .control = emfrail_control(verbose = FALSE))

# m4_parfm <- parfm(formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex, data = dat, frailty = "possta", dist = "exponential", cluster = "litter")
# m4_parfm
# 
# library(frailtySurv)
# ?frailtySurv

```

Results look like:
```{r rats2}
m1
m2
m3
m4
```

Profile log-likelihoods:
```{r rats3}
# profile likelihoods
#par(mfrow = c(2,2))

frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
                        .distribution = emfrail_distribution(dist = "gamma"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "gamma")


plot(frvar, emfrail_pll(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
                        .distribution = emfrail_distribution(dist = "pvf"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "IG")


plot(frvar, emfrail_pll(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1/2),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1/2")


plot(frvar, emfrail_pll(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1")
```

```{r rats3b}
#par(mfrow = c(1,1))

stabpar <- seq(from = 0.01, to = 1, length.out = 40)

plot(stabpar/(1 + stabpar), emfrail_pll(.data =  dat, .formula = Surv(rep(0, nrow(dat)), time, status) ~  rx + sex + cluster(litter),
                            .distribution = emfrail_distribution(dist = "stable"),
                            .values = stabpar),
     ylab = "log-likelihood",
     xlab = "kendall's tau (1-beta)",
     type = "l",
     main = "stable", col = 1)

#library(parfm)
#parfm(Surv(rep(0, nrow(dat)), time, status) ~  rx + sex, cluster = "litter", data = dat) ???
```

## kidney data
```{r kidney1}
data(kidney)
# type 'help(kidney)' for a description of the data set
kidney$sex <- kidney$sex - 1



m1 <- emfrail(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
              .distribution = emfrail_distribution(dist = "gamma"))

m2 <- emfrail(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
              .distribution = emfrail_distribution(dist = "pvf"))

m3 <- emfrail(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
              .distribution = emfrail_distribution(dist = "pvf", pvfm = 1/2))

m4 <- emfrail(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
              .distribution = emfrail_distribution(dist = "stable"))

# 
# predict(m1, lp = c(0, 0.5)) %>% 
#   ggplot(aes(x = time, y = survival)) + geom_step(aes(color = lp))
# 
# 
# 
# predict(m1, lp = c(0, 0.5)) %>% 
#   ggplot(aes(x = time, y = cumhaz)) + geom_step(aes(color = lp)) +
#   geom_step(aes(y = cumhaz_m, colour = lp), lty = "dotted") 
# 
# 
# 
# predict(m2, lp = c(0, 0.5)) %>% 
#   ggplot(aes(x = time, y = cumhaz)) + geom_step(aes(color = lp)) +
#   geom_step(aes(y = cumhaz_m, colour = lp), lty = "dotted") 
# 
# 
# predict(m2, lp = c(0, 0.5)) %>% 
#   select(time, cumhaz, cumhaz_m, lp) %>% 
#   unite(cumhaz_c_m, cumhaz, cumhaz_m) %>% 
#   spread(lp, cumhaz_c_m) %>% 
#   separate(`0`, into = c("cumhaz_0", "cumhaz_m_0"), sep = "_", convert = TRUE) %>% 
#   separate(`0.5`, into = c("cumhaz_05", "cumhaz_m_05"), sep = "_", convert = TRUE) %>% 
#   mutate(hr_c = cumhaz_05 / cumhaz_0,
#          hr_m = cumhaz_m_05 / cumhaz_m_0) %>% 
#   ggplot(aes(x = time)) + 
#   geom_step(aes(y = hr_c)) + 
#   geom_step(aes(y = hr_m), colour = 2)


```

Results:
```{r kidney2}
m1
m2
m3
m4
```

There are some warnings that appear from the `m4` model with the stable distribution, that is because the MLE there seems to be degenerate at the edge of the parameter space ($\beta = 1$). What happens there is that there is basically no association. The Laplace transform is $\mathcal{L}(c) = \exp(-c)$ 

Profile log-likelihoods
```{r kidney3}
# profile likelihoods
#par(mfrow = c(2,2))

frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
                        .distribution = emfrail_distribution(dist = "gamma"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "gamma")


frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "IG")


frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1/2),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1/2")


frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1")
```

```{r kidney4}
stabpar <- seq(from =0.01, to = 3, length.out = 20)

plot(stabpar/(1 + stabpar), emfrail_pll(.data =  kidney, .formula = Surv(rep(0, nrow(kidney)), time, status) ~  sex + age + cluster(id),
                           .distribution = emfrail_distribution(dist = "stable"),
                           .values = stabpar),
      ylab = "log-likelihood",
      xlab = "kendall's tau (1-beta)",
      type = "l",
      main = "stable", col = 1)
# 
```

## Simulated data set with gamma frailty
```{r sim11}
set.seed(1)
x <- sample(c(0,1), 300, TRUE)
z <- rep(rgamma(100, 1, 1), each = 3)

time <- rexp(300, rate = z * exp(0.5*x) )

censtime <- 5
status <- rep(1, 300)

status[time >= censtime] <- 0
time[status == 0] <- censtime
time0 <- rep(0, 300)

dd <- data.frame(id = rep(1:100, each = 3), x = x, time0 = time0, time = time, status = status)

coxph(Surv(time0, time, status) ~ x + frailty(id), ties = "breslow", data = dd)

m1 <- emfrail(.data =  dd, .formula = Surv(time0, time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "gamma"))

m2 <- emfrail(.data =  dd, .formula = Surv(time0, time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "pvf"))

m3 <- emfrail(.data = dd, .formula = Surv(time0, time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "pvf", pvfm = 1/2))

m4 <- emfrail(.data = dd, .formula = Surv(time0, time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "stable"))
```

Results:
```{r sim12}
m1
m2
m3
m4
```

Profile log-likelihoods
```{r sim13}
# profile likelihoods
#par(mfrow = c(2,2))

frvar <- seq(from = 0.1, to = 2.9, by = 0.18)
plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "gamma"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "gamma")


plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "IG")


plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1/2),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1/2")


plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1")


```

```{r sim14}
par(mfrow = c(1,1))

stabpar <- seq(from =0.1, to = 5, by = .1)
plot(stabpar / (1 + stabpar), emfrail_pll(.data =  dd,
                          .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                          .distribution = emfrail_distribution(dist = "stable"),
                          .values = stabpar),
     ylab = "log-likelihood",
     xlab = "Kendall's tau = 1-beta",
     type = "l",
     main = "stable")
```

## Simulated data with inverse gaussian frailty
```{r sim21}
library(statmod)

set.seed(1)
x <- sample(c(0,1), 300, TRUE)
z <- rep(rinvgauss(100), each = 3)

time <- rexp(300, rate = z * exp(0.5*x) )

censtime <- 5
status <- rep(1, 300)

status[time >= censtime] <- 0
time[status == 0] <- censtime
time0 <- rep(0, 300)

dd <- data.frame(id = rep(1:100, each = 3), x = x, time0 = time0, time = time, status = status)

m1 <- emfrail(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "gamma"))

m2 <- emfrail(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "pvf"), 
              .control = emfrail_control(opt_fit = TRUE))

m3 <- emfrail(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "pvf", pvfm = 1/2))

m4 <- emfrail(.data = dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
              .distribution = emfrail_distribution(dist = "stable"),
              .control =emfrail_control( verbose = FALSE))


```

Results
```{r sim22}
m1
m2
m3
m4
```

Profile log-likelihoods
```{r sim23}
# profile likelihoods
#par(mfrow = c(2,2))

frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "gamma", left_truncation = ),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "gamma")


plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "IG")


plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1/2),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1/2")


plot(frvar, emfrail_pll(.data =  dd, .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1")
```

```{r sim24}
#par(mfrow = c(1,1))

stabpar <- seq(from = 0.1, to = 10, length.out = 40)
plot(stabpar /(1 + stabpar), emfrail_pll(.data =  dd,
                            .formula = Surv(rep(0, nrow(dd)), time, status) ~  x + cluster(id),
                            .distribution = emfrail_distribution(dist = "stable"),
                            .values = stabpar),
     ylab = "log-likelihood",
     xlab = "Kendall's tau = 1-beta",
     type = "l",
     main = "stable")

```

## Left truncation
```{r lt1}
# simulate 300 clusters of size 5
set.seed(17)
x <- sample(c(0,1), 5 * 300, TRUE)
u <- rep(rgamma(300,1,1), each = 5)
stime <- rexp(5*300, rate = u * exp(x))
ltime <- runif(5 * 300)

library(tidyverse)
d <- data.frame(id = rep(1:300, each = 5),
                x = x,
                stime = stime,
                u = u,
                ltime = ltime,
                status = 1)


d1 <- d %>% filter(stime > ltime)

# Naive analysis (no updated frailty)
m1 <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id), .control = emfrail_control(verbose = TRUE))


m2 <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id),
          .control = emfrail_control(verbose = TRUE),
          .distribution = emfrail_distribution(dist = "pvf")
          )

m3 <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id),
          .control = emfrail_control(verbose = TRUE),
          .distribution = emfrail_distribution(dist = "pvf", pvfm = 1/2)
          )

m4 <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id), .control = emfrail_control(verbose = TRUE),
          .distribution = emfrail_distribution(dist = "stable"))
```
Results of naive analysis (what `coxph` also does):
```{r lt2}
m1
m2
m3
m4
```

Profile log-likelihood
```{r lt3}
# profile likelihoods
#par(mfrow = c(2,2))

frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "gamma"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "gamma")


plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf"),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "IG")
m2

plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1/2),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1/2")


plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1")
```


```{r lt4}
#par(mfrow = c(1,1))

stabpar <- seq(from = 0.1, to = 3, length.out = 15)
plot(stabpar /(1 + stabpar), emfrail_pll(.data =  d1,
                            .formula = Surv(ltime, stime, status)~ x + cluster(id),
                            .distribution = emfrail_distribution(dist = "stable"),
                            .values = stabpar),
     ylab = "log-likelihood",
     xlab = "Kendall's tau = 1-beta",
     type = "l",
     main = "stable")

```

### Correct analysis
Now I use the distribution of the frailty given the left truncation

```{r lt5}

# this is the correct way here:
m1_lt <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id), .control = emfrail_control(verbose = FALSE),
          .distribution = emfrail_distribution(left_truncation = TRUE))

m2_lt <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id), .control = emfrail_control(verbose = TRUE),
          .distribution = emfrail_distribution(dist = "pvf", left_truncation = TRUE))

library(parfm)

parfm(Surv(ltime, stime, status)~ x , cluster = "id", data = d1, frailty = "ingau", dist = "exponential")

m3_lt <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id),
          .control = emfrail_control(verbose = TRUE),
          .distribution = emfrail_distribution(dist = "pvf", pvfm = 1/2, left_truncation = TRUE)
  )

m4_lt <- d1 %>%
  emfrail(Surv(ltime, stime, status)~ x + cluster(id), .control = emfrail_control(verbose = FALSE),
          .distribution = emfrail_distribution(dist = "stable", left_truncation = TRUE))
```

Results:
```{r lt6}
m1_lt
m2_lt
m3_lt
m4_lt
```

Profile log-likelihoods:
```{r lt7}
# profile likelihoods
# par(mfrow = c(2,2))

frvar <- seq(from = 0.1, to = 1.5, by = 0.1)
plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "gamma", left_truncation = TRUE),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "gamma")


plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf", left_truncation = TRUE),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "IG")


plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1/2,
                                                             left_truncation = TRUE),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1/2")


plot(frvar, emfrail_pll(.data =  d1, .formula = Surv(ltime, stime, status)~ x + cluster(id),
                        .distribution = emfrail_distribution(dist = "pvf",
                                                             pvfm = 1,
                                                             left_truncation  = TRUE),
                        .values = 1/frvar),
     ylab = "log-likelihood",
     xlab = "frailty variance",
     type = "l",
     main = "pvf m=1")
```

```{r lt8}
# par(mfrow = c(1,1))

stabpar <- seq(from = 0.1, to = 3, length.out = 15)
plot(stabpar /(1 + stabpar), emfrail_pll(.data =  d1,
                            .formula = Surv(ltime, stime, status)~ x + cluster(id),
                            .distribution = emfrail_distribution(dist = "stable", left_truncation = TRUE),
                            .values = stabpar),
     ylab = "log-likelihood",
     xlab = "Kendall's tau = 1-beta",
     type = "l",
     main = "stable")

```
